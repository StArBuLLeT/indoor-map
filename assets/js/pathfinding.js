var DELAY=500,clicks=0,timer=null;!function(t){"use strict";var o={maps:[{path:"floorplan.svg",id:"map.1"}],path:{color:"red",radius:10,speed:8,width:3},startpoint:function(){return"startpoint"},endpoint:!1,accessibleRoute:!1,defaultMap:function(){return"map.1"},dataStoreCache:!1,showLocation:!1,locationIndicator:{fill:"red",height:40},wayFound:!1,zoomToRoute:!1,zoomPadding:50,mapEvents:!1};t.fn.wayfinding=function(a,e){var r,s,n,p,i,l,h,f=e,u={paths:[],portals:[]},c=[];function d(t){t.data("wayfinding:options",e),t.data("wayfinding:drawing",i),t.data("wayfinding:data",u)}function g(o,a){var r,s;if(t("path.locationIndicator",a).remove(),e.startpoint="function"==typeof o?o():o,p=e.startpoint,e.showLocation){if(!(r=t("#Doors #"+p,a)).length)return;s=function(o,a){var r,s,n,p;return r=document.createElementNS("http://www.w3.org/2000/svg","path"),t(r).attr("class","locationIndicator"),p="M "+o+" "+a,p+=" l "+(n=5*(s=e.locationIndicator.height)/8)/2+" "+-2*s/3,p+=" a "+n/2+" "+s/3,p+=" 0 0 0 ",p+=-1*n+" 0 ",p+="Z",p+=" m "+s/-8+" "+-2*s/3,p+=" a "+s/8+" "+s/8,p+=" 0 1 0 ",p+=s/4+" 0",p+=" a "+s/8+" "+s/8,p+=" 0 1 0 ",p+=s/-4+" 0",r.setAttribute("d",p),r.setAttribute("fill",e.locationIndicator.fill),r.setAttribute("fill-rule","evenodd"),r.setAttribute("stroke","black"),r}((Number(r.attr("x1"))+Number(r.attr("x2")))/2,(Number(r.attr("y1"))+Number(r.attr("y2")))/2),r.after(s)}}function y(o){var a=0;t.each(s,function(r,p){var i=t('<div id="'+p.id+'"></div>');i.load(p.path,function(l){a+=1,s[r].svgHandle=l,function(o,a){t(a).hide(),t("#Paths line",a).attr("stroke-opacity",0),t("#Doors line",a).attr("stroke-opacity",0),t("#Portals line",a).attr("stroke-opacity",0),t("#Rooms a, #Doors line",a).each(function(){if(t(this).prop("id")&&t(this).prop("id").indexOf("_")>0){var o=t(this).prop("id");t(this).prop("id",o.slice(0,o.indexOf("_")))}}),t("#Rooms a",a).bind({click:function(a){null===timer&&(timer=setTimeout(function(){1===clicks&&(t(o).wayfinding("routeTo",a.currentTarget.id),a.preventDefault()),clicks=0,timer=null},DELAY)),2==++clicks&&(clearTimeout(timer),clicks=0,timer=null)},dblclick:function(t){t.preventDefault()}})}(o,i),o.append(this),e.dataStoreCache||(function(o,a,e){var r,s,n,p,i,l,h,f;u.paths[a]=[],t("#"+e.id+" #Paths line",o).each(function(){(r={}).floor=e.id,r.mapNum=a,r.route=1/0,r.prior=-1,r.ax=t(this).prop("x1").animVal.value,r.ay=t(this).prop("y1").animVal.value,r.doorA=[],r.bx=t(this).prop("x2").animVal.value,r.by=t(this).prop("y2").animVal.value,r.doorB=[],r.length=Math.sqrt(Math.pow(r.ax-r.bx,2)+Math.pow(r.ay-r.by,2)),r.connections=[],r.portals=[],u.paths[a].push(r)}),t("#"+e.id+" #Doors line",o).each(function(){n=t(this).prop("x1").animVal.value,p=t(this).prop("y1").animVal.value,i=t(this).prop("x2").animVal.value,l=t(this).prop("y2").animVal.value,s=t(this).prop("id"),t.each(u.paths[a],function(t,o){e.id===o.floor&&(o.ax===n&&o.ay===p||o.ax===i&&o.ay===l)?o.doorA.push(s):e.id===o.floor&&(o.bx===n&&o.by===p||o.bx===i&&o.by===l)&&o.doorB.push(s)})}),t("#"+e.id+" #Portals line",o).each(function(){h={},(f=t(this).prop("id"))&&f.indexOf("_")>-1&&(f=f.slice(0,f.indexOf("_"))),h.id=f,h.type=f.split(".")[0],h.floor=e.id,h.mate=f.split(".").slice(0,2).join(".")+"."+e.id,h.mapNum=a,h.matched=!1,n=t(this).prop("x1").animVal.value,p=t(this).prop("y1").animVal.value,i=t(this).prop("x2").animVal.value,l=t(this).prop("y2").animVal.value,0!==t.grep(u.paths[a],function(t){return n===t.ax&&p===t.ay||n===t.bx&&p===t.by}).length?(h.x=n,h.y=p):(h.x=i,h.y=l),h.length=Math.sqrt(Math.pow(n-i,2)+Math.pow(p-l,2)),c.push(h)})}(o,r,p),a===s.length&&function(){var t,o,a,e,r,n,p,i,l,h;for(t=0;t<c.length;t++)if(!1===(a=c[t]).matched)for(o=t;o<c.length;o++)c[o].id===a.mate&&c[o].mate===a.id&&(e=c[o],r={},a.matched=!0,e.matched=!0,r.type=a.type,r.accessible="Elev"===r.type||"Door"===r.type,r.idA=a.id,r.floorA=a.floor,r.floorANum=a.mapNum,r.xA=a.x,r.yA=a.y,r.connectionsA=[],r.idB=e.id,r.floorB=e.floor,r.floorBNum=e.mapNum,r.xB=e.x,r.yB=e.y,r.connectionsB=[],r.length=a.length+e.length,r.route=1/0,r.prior=-1,u.portals.push(r));for(n=0;n<s.length;n++)for(p=0;p<u.paths[n].length-1;p++)for(i=p+1;i<u.paths[n].length;i++)(u.paths[n][i].ax===u.paths[n][p].ax&&u.paths[n][i].ay===u.paths[n][p].ay||u.paths[n][i].bx===u.paths[n][p].ax&&u.paths[n][i].by===u.paths[n][p].ay||u.paths[n][i].ax===u.paths[n][p].bx&&u.paths[n][i].ay===u.paths[n][p].by||u.paths[n][i].bx===u.paths[n][p].bx&&u.paths[n][i].by===u.paths[n][p].by)&&(u.paths[n][p].connections.push(i),u.paths[n][i].connections.push(p));for(l=0;l<u.portals.length;l++)for(n=0;n<s.length;n++)for(h=0;h<u.paths[n].length;h++)u.portals[l].floorA===u.paths[n][h].floor&&(u.portals[l].xA===u.paths[n][h].ax&&u.portals[l].yA===u.paths[n][h].ay||u.portals[l].xA===u.paths[n][h].bx&&u.portals[l].yA===u.paths[n][h].by)?(u.portals[l].connectionsA.push(h),u.paths[n][h].portals.push(l)):u.portals[l].floorB===u.paths[n][h].floor&&(u.portals[l].xB===u.paths[n][h].ax&&u.portals[l].yB===u.paths[n][h].ay||u.portals[l].xB===u.paths[n][h].bx&&u.portals[l].yB===u.paths[n][h].by)&&(u.portals[l].connectionsB.push(h),u.paths[n][h].portals.push(l));c=[]}()),a===s.length&&(g(e.startpoint,o),d(o),function(o){var a,r;for(t("#mapLoading").remove(),a=0,r=0;r<s.length;r++)n===s[r].id&&(a=r);t("#"+s[a].id,o).show(0,function(){t(this).trigger("wfMapsVisible")}),"function"==typeof e.endpoint?w(e.endpoint()):"string"==typeof e.endpoint&&w(e.endpoint)}(o))})})}function m(o,a){var r,n,p,l;if(t("div",a).hide(),t("#"+o,a).show(0,function(){e.mapEvents&&t(a).trigger("wfFloorChange")}),i){for(p=-1,r=0;r<s.length;r++)s[r]===o&&(p=r);for(n=-1,r=0;r<i.length;r++)i[r].floor===p&&(n=r);-1!==n&&(l=i[n].routeLength,t(i[n].path,a).attr("stroke-dasharray",[l,l]),t(i[n].path,a).attr("stroke-dashoffset",l),t(i[n].path,a).attr("pathLength",l),t(i[n].path,a).attr("stroke-dashoffset",l),t(i[n].path,a).animate({svgStrokeDashOffset:0},l*e.path.speed))}}function b(o,a){var n,p,i,l,h,f,u=e.zoomPadding;a>=o.length||(f=(h=o[a].routeLength)*e.path.speed,m(s[o[a][0].floor].id,r),(n=t("#"+s[o[a][0].floor].id+" .directionPath"+a)[0]).style.stroke=e.path.color,n.style.strokeWidth=e.path.width,n.style.transition=n.style.WebkitTransition="none",n.style.strokeDasharray=h+" "+h,n.style.strokeDashoffset=h,i=n.getBBox(),n.style.transition=n.style.WebkitTransition="stroke-dashoffset "+f+"ms linear",n.style.strokeDashoffset="0",p=t("#"+s[o[a][0].floor].id+" svg")[0],l=p.getAttribute("viewBox"),e.zoomToRoute&&p.setAttribute("viewBox",i.x-u+" "+(i.y-u)+" "+(i.width+2*u)+" "+(i.height+2*u)),setTimeout(function(){b(o,++a),p.setAttribute("viewBox",l)},f+1e3))}function x(t){var o,a,e,r,n={paths:[],floor:null};for(o=0;o<s.length;o++)for(a=0;a<u.paths[o].length;a++){for(e=0;e<u.paths[o][a].doorA.length;e++)u.paths[o][a].doorA[e]===t&&(n.paths.push(a),n.floor=u.paths[o][a].floor);for(r=0;r<u.paths[o][a].doorB.length;r++)u.paths[o][a].doorB[r]===t&&(n.paths.push(a),n.floor=u.paths[o][a].floor)}return n}function v(o){function a(t){var o,a,e,r,n,i;for(o=x(t),a=0;a<s.length;a++)s[a].id===o.floor&&(n=a);for(e=1/0,r=-1,i=0;i<o.paths.length;i++)u.paths[n][o.paths[i]].route<e&&(e=u.paths[n][o.paths[i]].route,r=o.paths[i]);return-1!==r?(l=[],function t(o,a,e){var r;if("door"!==e)switch((r={}).type=o,r.floor=a,r.segment=e,l.push(r),o){case"pa":t(u.paths[a][e].priorType,a,u.paths[a][e].prior);break;case"po":t(u.portals[e].priorType,u.portals[e].priormapNum,u.portals[e].prior)}}("pa",n,r),l.reverse(),{startpoint:p,endpoint:t,solution:l,distance:e}):{startpoint:p,endpoint:t,solution:[],distance:e}}return A(),Array.isArray(o)?t.map(o,function(t){return a(t)}):a(o)}function A(){var o,a,n;if(!e.wayFound){for(o=x(p),a=0;a<s.length;a++)s[a].id===o.floor&&(n=a);!function(){var t,o,a;for(t=0;t<s.length;t++)for(o=0;o<u.paths[t].length;o++)u.paths[t][o].route=1/0,u.paths[t][o].prior=-1;for(a=0;a<u.portals.length;a++)u.portals[a].route=1/0,u.portals[a].prior=-1,u.portals[a].priormapNum=-1}(),t.each(o.paths,function(o,a){u.paths[n][a].route=u.paths[n][a].length,u.paths[n][a].prior="door",function o(a,r,s,n){t.each(u.paths[r][s].connections,function(t,e){n+u.paths[r][e].length<u.paths[r][e].route&&(u.paths[r][e].route=n+u.paths[r][e].length,u.paths[r][e].prior=s,u.paths[r][e].priorType=a,o("pa",r,e,u.paths[r][e].route))}),u.paths[r][s].portals.length>0&&t.each(u.paths[r][s].portals,function(p,i){n+u.portals[i].length<u.portals[i].route&&(!1===e.accessibleRoute||!0===e.accessibleRoute&&u.portals[i].accessible)&&(u.portals[i].route=n+u.portals[i].length,u.portals[i].prior=s,u.portals[i].priormapNum=u.paths[r][s].mapNum,u.portals[i].priorType=a,-1!==t.inArray(s,u.portals[i].connectionsA)?t.each(u.portals[i].connectionsB,function(t,a){n+u.portals[i].length+u.paths[u.portals[i].floorBNum][a].length<u.paths[u.portals[i].floorBNum][a].route&&(u.paths[u.portals[i].floorBNum][a].route=u.portals[i].route+u.paths[u.portals[i].floorBNum][a].length,u.paths[u.portals[i].floorBNum][a].prior=i,u.paths[u.portals[i].floorBNum][a].priorType="po",o("pa",u.portals[i].floorBNum,a,u.paths[u.portals[i].floorBNum][a].route))}):t.each(u.portals[i].connectionsA,function(t,a){n+u.portals[i].length+u.paths[u.portals[i].floorANum][a].length<u.paths[u.portals[i].floorANum][a].route&&(u.paths[u.portals[i].floorANum][a].route=u.portals[i].route+u.paths[u.portals[i].floorANum][a].length,u.paths[u.portals[i].floorANum][a].prior=i,u.paths[u.portals[i].floorANum][a].priorType="po",o("pa",u.portals[i].floorANum,a,u.paths[u.portals[i].floorANum][a].route))}))}),e.wayFound=!0}("pa",n,a,u.paths[n][a].length)}),d(r)}}function w(o){var a,n,h,f,c,d,g,y,m,x,A,w,N,k,B,L,M,R,S,T,P,D,V;if(e.endpoint=o,t("path[class^=directionPath]",r).remove(),t("#Rooms *.wayfindingRoom",r).removeAttr("class"),l=[],p!==o){for(t('#Rooms a[id="'+o+'"] g',r).attr("class","wayfindingRoom"),l=v(o).solution,c=0,a=0;a<l.length;a++)"po"===l[a].type&&c++;for((i=new Array(c))[0]=[],n={},u.paths[l[0].floor][l[0].segment].doorA[0]===p?((n={}).floor=[l[0].floor],n.type="M",n.x=u.paths[l[0].floor][l[0].segment].ax,n.y=u.paths[l[0].floor][l[0].segment].ay,n.length=0,i[0].push(n),(n={}).type="L",n.floor=[l[0].floor],n.x=u.paths[l[0].floor][l[0].segment].bx,n.y=u.paths[l[0].floor][l[0].segment].by,n.length=u.paths[l[0].floor][l[0].segment].length,i[0].push(n),i[0].routeLength=n.length):u.paths[l[0].floor][l[0].segment].doorB[0]===p&&((n={}).type="M",n.floor=[l[0].floor],n.x=u.paths[l[0].floor][l[0].segment].bx,n.y=u.paths[l[0].floor][l[0].segment].by,n.length=0,i[0].push(n),(n={}).type="L",n.floor=[l[0].floor],n.x=u.paths[l[0].floor][l[0].segment].ax,n.y=u.paths[l[0].floor][l[0].segment].ay,n.length=u.paths[l[0].floor][l[0].segment].length,i[0].push(n),i[0].routeLength=n.length),d=1,a=0;a<c+1;a++)for(h=d;h<l.length;h++)"pa"===l[h].type&&(g=u.paths[l[h].floor][l[h].segment].ax,y=u.paths[l[h].floor][l[h].segment].ay,m=u.paths[l[h].floor][l[h].segment].bx,x=u.paths[l[h].floor][l[h].segment].by,(n={}).floor=l[h].floor,i[a].slice(-1)[0].x===g&&i[a].slice(-1)[0].y===y?(n.x=m,n.y=x):(n.x=g,n.y=y),n.length=u.paths[l[h].floor][l[h].segment].length,n.type="L",i[a].push(n),i[a].routeLength+=n.length),"po"===l[h].type&&(i[a+1]=[],i[a+1].routeLength=0,V="",u.portals[l[h].segment].floorANum===u.portals[l[h].segment].floorBNum?V=u.portals[l[h].segment].xA===n.x&&u.portals[l[h].segment].yA===n.y?"B":"A":u.portals[l[h].segment].floorANum===l[h].floor?V="A":u.portals[l[h].segment].floorBNum===l[h].floor&&(V="B"),"A"===V?((n={}).floor=l[h].floor,n.type="M",n.x=u.portals[l[h].segment].xA,n.y=u.portals[l[h].segment].yA,n.length=0,i[a+1].push(n),i[a+1].routeLength=n.length):"B"===V&&((n={}).floor=l[h].floor,n.type="M",n.x=u.portals[l[h].segment].xB,n.y=u.portals[l[h].segment].yB,n.length=0,i[a+1].push(n),i[a+1].routeLength=n.length),d=h,d++,h=l.length);if(e.path.radius>0)for(f=0;f<i.length;f++){for(a=1;a<i[f].length-1;a++)"L"===i[f][a].type&&"L"===i[f][a].type&&(A=i[f][a-1].x-i[f][a].x,w=i[f][a-1].y-i[f][a].y,N=i[f][a].x-i[f][a+1].x,k=i[f][a].y-i[f][a+1].y,(0===w&&0===k||0===A&&0===N||A/w==N/k&&(0!==A||0!==w||0!==N||0!==k))&&(i[f][a+1].length=i[f][a].length+i[f][a+1].length,i[f].splice(a,1),a=1));for(a=1;a<i[f].length-1;a++)"L"===i[f][a].type&&"L"===i[f][a].type&&i[f][a].length>e.path.radius&&i[f][a+1].length>e.path.radius&&(B=i[f][a].x,L=i[f][a].y,M=i[f][a-1].x,R=i[f][a-1].y,i[f][a].x=Number(M)+(B-M)*((i[f][a].length-e.path.radius)/i[f][a].length),i[f][a].y=Number(R)+(L-R)*((i[f][a].length-e.path.radius)/i[f][a].length),i[f][a].length=i[f][a].length-e.path.radius,(S={}).cx=B,S.cy=L,T=i[f][a+1].x,P=i[f][a+1].y,S.x=Number(B)+(T-B)*(e.path.radius/i[f][a+1].length),S.y=Number(L)+(P-L)*(e.path.radius/i[f][a+1].length),i[f][a+1].length=i[f][a+1].length-e.path.radius,S.type="Q",S.floor=i[f][a].floor,i[f].splice(a+1,0,S))}t.each(i,function(o,a){var e,r="";t.each(a,function(t,o){switch(o.type){case"M":r="M"+o.x+","+o.y;break;case"L":r+="L"+o.x+","+o.y;break;case"Q":r+="Q"+o.cx+","+o.cy+" "+o.x+","+o.y}}),(e=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",r),e.style.fill="none",e.classList?e.classList.add("directionPath"+o):e.setAttribute("class","directionPath"+o),t("#"+s[a[0].floor].id+" svg g").first().append(e),D=t("#"+s[a[0].floor].id+" svg .directionPath"+o),i[o].path=D,i[o].routeLength}),b(i,0)}}return a&&"object"==typeof a&&(e=a,a="initialize"),this.each(function(){var l,c,x,N;if(r=t(this),c=(l=r).data("wayfinding:options"),x=l.data("wayfinding:data"),i=l.data("wayfinding:drawing"),e=void 0!==c?c:t.extend(!0,{},o,e),e=t.metadata?t.extend(!0,{},e,l.metadata()):e,s=e.maps,n="function"==typeof e.defaultMap?e.defaultMap():e.defaultMap,"function"==typeof e.startpoint?g(e.startpoint(),l):p=e.startpoint,void 0!==x&&(u=x),a&&"string"==typeof a)switch(a){case"initialize":!function(){var t,o,a=!1,e=!1;if(s.length>0){for(t=0;t<s.length;t++)for(o=t;o<s.length;o++)t!==o&&s[t].id===s[o].id&&(a=!0);if(!0===a)for(t=0;t<s.length;t++)s[t].id="map_"+t;for(t=0;t<s.length;t++)s[t].id===n&&(e=!0);!1===e&&(n=s[0].id)}}(),N=r,e.dataStoreCache?"object"==typeof e.dataStoreCache?(u=e.dataStoreCache,y(N)):"string"==typeof e.dataStoreCache&&t.getJSON(e.dataStoreCache,function(t){u=t,y(N)}).fail(function(){console.log("Failed to get dataStore cache. Falling back to client-side dataStore generation."),u.paths=[],u.portals=[],e.dataStoreCache=!1,y(N)}):(u.paths=[],u.portals=[],y(N));break;case"routeTo":w(f);break;case"animatePath":!function(o){t("path[class^=directionPath]",o).css({stroke:"none"})}(r),b(i,0);break;case"startpoint":void 0===f?h=p:(e.wayFound=!1,g(f));break;case"currentMap":void 0===f?h=t("div:visible",r).prop("id"):m(f,r);break;case"accessibleRoute":void 0===f?h=e.accessibleRoute:(e.accessibleRoute!==f&&(e.wayFound=!1),e.accessibleRoute=f);break;case"path":void 0===f?h=e.path:e.path=t.extend(!0,{},e.path,f);break;case"checkMap":h=function(o){var a,e,r,n=[],p=0;for(A(),a=0;a<s.length;a++){for(n[p++]="Checking map: "+a,e=0;e<u.paths[a].length;e++)u.paths[a][e].route!==1/0&&-1!==u.paths[a][e].prior||(n[p++]="unreachable path: "+e,(r=document.createElementNS("http://www.w3.org/2000/svg","line")).setAttribute("class","debugPath"),r.setAttribute("x1",u.paths[a][e].ax),r.setAttribute("y1",u.paths[a][e].ay),r.setAttribute("x2",u.paths[a][e].bx),r.setAttribute("y2",u.paths[a][e].by),t("#"+u.paths[a][e].floor+" #Paths",o).append(r));n[p++]="\n",t("#"+u.paths[a][0].floor+" #Rooms a",o).each(function(o,a){0===v(t(a).prop("id")).solution.length&&(n[p++]="unreachable room: "+t(a).prop("id"),t(a).attr("class","debugRoom"))}),n[p++]="\n"}return n.join("\n")}(r);break;case"getDataStore":h=JSON.stringify(u),t("body").replaceWith(h);break;case"getRoutes":h=v(void 0===f?e.endpoint:f);break;case"destroy":t(r).remove()}d(r)}),void 0!==h?h:this}}(jQuery);